---
import CodeBlock from './CodeBlock.astro';
---

<section class="py-24 space-y-32 container mx-auto px-4">
    <!-- Header -->
    <div class="max-w-4xl fade-in">
        <h1 class="text-4xl md:text-6xl font-bold text-white mb-8 leading-none">
            Kotlin Multiplatform <br>
            <span class="text-blue-500">Workflow</span>
        </h1>
        <p class="text-xl text-slate-400 font-mono tracking-tight leading-relaxed border-l-4 border-blue-500 pl-6">
            Mastering Kotlin Multiplatform (KMP) in a Bare Hub environment. 
            Optimize Gradle performance, manage shared caches, and orchestrate parallel builds across Android, iOS, and Web.
        </p>
    </div>

    <!-- 01. The Gradle Dilemma -->
    <div class="fade-in space-y-12">
        <div class="flex items-center gap-4">
            <span class="text-blue-500 font-bold text-2xl">01</span>
            <h2 class="text-3xl font-bold text-white tracking-wide">The Gradle Dilemma</h2>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
            <div class="space-y-6">
                <p class="text-slate-300 leading-relaxed">
                    Gradle is notorious for its daemon overhead and cache management. Running multiple KMP projects in parallel can typically lead to:
                </p>
                <ul class="space-y-4">
                    <li class="flex items-center gap-3 text-slate-400">
                        <span class="text-red-500 font-bold">×</span> Lock file contention in connection to the Global Cache.
                    </li>
                    <li class="flex items-center gap-3 text-slate-400">
                        <span class="text-red-500 font-bold">×</span> Massive memory spikes from multiple Daemons.
                    </li>
                    <li class="flex items-center gap-3 text-slate-400">
                        <span class="text-red-500 font-bold">×</span> Redundant downloads of dependencies.
                    </li>
                </ul>
            </div>
            <div class="p-8 bg-slate-900 border border-slate-800 rounded-xl">
                <h3 class="text-xl font-bold text-blue-400 mb-4">The Worktree Solution</h3>
                <p class="text-sm text-slate-400 mb-6">
                    By strictly defining cache scopes and using the Bare Hub to isolate environments, we can run Android updates and iOS logic refactors simultaneously without killing the machine.
                </p>
            </div>
        </div>
    </div>

    <!-- 02. Configuration Strategy -->
    <div class="fade-in space-y-12">
        <div class="flex items-center gap-4">
            <span class="text-blue-500 font-bold text-2xl">02</span>
            <h2 class="text-3xl font-bold text-white tracking-wide">Configuration Strategy</h2>
        </div>

        <div class="grid grid-cols-1 gap-6">
            <div class="space-y-4">
                 <h3 class="text-2xl font-bold text-white">1. Isolate the Build Cache (Optional)</h3>
                 <p class="text-slate-400 text-sm">If you experience lock issues, you can instruct Gradle to use a worktree-specific cache, though a shared cache is usually preferred for speed.</p>
                 <CodeBlock code={`# gradle.properties
org.gradle.caching=true
org.gradle.caching.local.directory=.gradle/build-cache`} label="Properties" />
            </div>

            <div class="space-y-4">
                 <h3 class="text-2xl font-bold text-white">2. Share the Dependency Cache</h3>
                 <p class="text-slate-400 text-sm">Never re-download jars. Ensure `GRADLE_USER_HOME` points to a global location, or use the default.</p>
                 <CodeBlock code={`export GRADLE_USER_HOME=$HOME/.gradle`} label="Shell" />
            </div>
        </div>
    </div>

    <!-- 03. Workflow Scenarios -->
    <div class="fade-in space-y-12">
        <div class="flex items-center gap-4">
            <span class="text-blue-500 font-bold text-2xl">03</span>
            <h2 class="text-3xl font-bold text-white tracking-wide">Workflow Scenarios</h2>
        </div>

        <div class="space-y-12">
            <!-- Scenario A -->
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-8">
                <div class="flex flex-col md:flex-row gap-8 items-start">
                    <div class="flex-1 space-y-4">
                        <h3 class="text-xl font-bold text-white">Scenario A: The "Core" Update</h3>
                        <p class="text-slate-400 text-sm">
                            You are refactoring `shared/src/commonMain`. This is a deep change. You don't want to break the UI work happening on a feature branch.
                        </p>
                        <ul class="text-xs text-slate-500 space-y-2 font-mono">
                            <li>> Create worktree `../core-refactor`</li>
                            <li>> Run `./gradlew :shared:build`</li>
                            <li>> Run `./gradlew :shared:koverHtmlReport`</li>
                        </ul>
                    </div>
                     <div class="w-full md:w-1/2">
                        <CodeBlock code={`worktree add core-refactor feature/shared-logic
cd ../core-refactor
./gradlew clean :shared:testDebugUnitTest`} label="Shell" />
                    </div>
                </div>
            </div>

            <!-- Scenario B -->
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-8">
                <div class="flex flex-col md:flex-row gap-8 items-start">
                    <div class="flex-1 space-y-4">
                        <h3 class="text-xl font-bold text-white">Scenario B: UI Polish (Android & iOS)</h3>
                        <p class="text-slate-400 text-sm">
                            You need to check how the new logic renders on Android. You open Android Studio pointed SPECIFICALLY at this worktree.
                        </p>
                        <ul class="text-xs text-slate-500 space-y-2 font-mono">
                            <li>> Open Android Studio -> Open Project -> `../ui-feature/androidApp`</li>
                            <li>> Gradle Syncs only for this folder.</li>
                        </ul>
                    </div>
                     <div class="w-full md:w-1/2">
                        <CodeBlock code={`# In a separate terminal
open -a "Android Studio" ../ui-feature`} label="Shell" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 04. Optimization Tips -->
    <div class="fade-in space-y-12">
        <div class="flex items-center gap-4">
            <span class="text-slate-400 font-bold text-2xl">04</span>
            <h2 class="text-3xl font-bold text-white tracking-wide">Optimization Tips</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="p-6 bg-slate-900 border border-slate-800 rounded-lg">
                <h4 class="text-blue-400 font-bold mb-3">Daemon Management</h4>
                <p class="text-xs text-slate-400">
                    Be careful with memory. If you open 4 worktrees and 4 Android Studios, you will spawn 4 Gradle Daemons. Kill idle ones with `./gradlew --stop`.
                </p>
            </div>
            <div class="p-6 bg-slate-900 border border-slate-800 rounded-lg">
                <h4 class="text-blue-400 font-bold mb-3">Local.properties</h4>
                <p class="text-xs text-slate-400">
                    `local.properties` (SDK location) is usually gitignored. You might need to copy it to each new worktree or symlink it from the root.
                </p>
            </div>
            <div class="p-6 bg-slate-900 border border-slate-800 rounded-lg">
                <h4 class="text-blue-400 font-bold mb-3">XCode Derivation</h4>
                <p class="text-xs text-slate-400">
                    For iOS, ensure your Pods or SPM setup is isolated per worktree to avoid DerivedData conflicts.
                </p>
            </div>
            <div class="p-6 bg-slate-900 border border-slate-800 rounded-lg col-span-1 md:col-span-3">
                <h4 class="text-pink-400 font-bold mb-3">Hyper-Cleaning</h4>
                <p class="text-xs text-slate-400">
                    Kotlin projects accumulate massive <code>build/</code> and <code>.gradle/</code> folders. Use <code>worktree clean --artifacts</code> (or <code>Shift+C</code> in the TUI) to purge these from background worktrees while keeping your current environment intact.
                </p>
            </div>
        </div>
    </div>
</section>
