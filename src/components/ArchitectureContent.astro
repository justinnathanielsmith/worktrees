---
import CodeBlock from './CodeBlock.astro';
---

<section class="py-24 space-y-32 container mx-auto px-4">
    <!-- Header -->
    <div class="max-w-4xl fade-in">
        <h1 class="text-4xl md:text-6xl font-bold text-white mb-8 leading-none">
            Architecture <br>
            <span class="text-blue-500">Overview</span>
        </h1>
        <p class="text-xl text-slate-400 font-mono tracking-tight leading-relaxed border-l-4 border-blue-500 pl-6">
            A technical specification for decoupling the Git versioning engine from the working directory. 
            Designed for high-concurrency development environments and multi-agent orchestration.
        </p>
    </div>

    <!-- 01. Core Concepts -->
    <div class="fade-in space-y-12">
        <div class="flex items-center gap-4">
            <span class="text-blue-500 font-bold text-2xl">01</span>
            <h2 class="text-3xl font-bold text-white tracking-wide">Core Concepts</h2>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
            <div class="space-y-6">
                <h3 class="text-2xl font-bold text-blue-400">The Bare Repository (The Engine)</h3>
                <p class="text-slate-300 leading-relaxed">
                    A standard Git repository contains both the version history (the `.git` folder) and your working files. 
                    A <strong>Bare Repository</strong> contains only the version history. There are no working files, no "checked out" state, and no `HEAD` in the traditional sense. It acts as a local server—a single source of truth for all worktrees.
                </p>
                <div class="p-6 bg-slate-900 border border-slate-800 rounded-xl">
                    <h4 class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-2">Technical Insight</h4>
                    <p class="text-xs text-slate-500 leading-relaxed">By using a bare repository as the hub, you prevent the common "nested git" issues and ensure that every worktree is a first-class citizen with direct access to the shared object database.</p>
                </div>
            </div>
            <div class="space-y-6">
                <h3 class="text-2xl font-bold text-blue-400">The Worktree (The Workspace)</h3>
                <p class="text-slate-300 leading-relaxed">
                    Worktrees are physical directories that represent a specific branch or commit. Unlike a standard checkout where switching branches changes the files in place, a worktree checkout creates a <strong>new physical folder</strong> while sharing the same underlying history stored in the Bare Engine.
                </p>
                <div class="p-6 bg-slate-900 border border-slate-800 rounded-xl">
                    <h4 class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-2">The shared .git file</h4>
                    <p class="text-xs text-slate-500 leading-relaxed">Each worktree contains a `.git` <strong>file</strong> (not a folder) that points back to the central repository.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 02. Worktrees: The Stash Killer -->
    <div class="fade-in space-y-12">
        <div class="flex items-center gap-4">
            <span class="text-blue-500 font-bold text-2xl">02</span>
            <h2 class="text-3xl font-bold text-white tracking-wide">Worktrees: The Stash Killer</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
            <div class="space-y-6 text-slate-300 leading-relaxed text-lg">
                <p>
                    Most developers rely on <code class="text-blue-400 bg-blue-400/10 px-2 py-1 rounded">git stash</code> to temporarily store uncommitted work. However, stashing is inherently <strong>destructive</strong> and ephemeral. It forces you to wipe your current state and leads to "stash-amnesia"—forgetting what was stored, why it was stored, and losing track of vital context.
                </p>
                <p>
                    Worktrees eliminate this bottleneck by providing <strong>persistent, named environments</strong>. Instead of hiding your work in a stack, you move it to a physical workspace where it remains alive, isolated, and ready for immediate resumption.
                </p>
            </div>
            <div class="space-y-4">
                <div class="bg-slate-900 p-8 border border-slate-800 rounded-xl relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <span class="text-6xl">⚔️</span>
                    </div>
                    <h4 class="text-white font-bold mb-6 flex items-center gap-2">
                        <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                        Why it's Superior
                    </h4>
                    <ul class="space-y-4 text-slate-400">
                        <li class="flex items-start gap-3">
                            <span class="text-blue-500 font-bold">✓</span>
                            <span><strong>Non-Destructive:</strong> No more "popping" errors or lost hunks. Your uncommitted changes stay exactly where you left them.</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="text-blue-500 font-bold">✓</span>
                            <span><strong>Context Isolation:</strong> Each task has its own physical folder. No more polluting your IDE with unrelated branch files.</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="text-blue-500 font-bold">✓</span>
                            <span><strong>Parallel Development:</strong> Keep your feature branch running in one terminal while you fix a hotfix in another.</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="p-6 bg-slate-900/50 border border-slate-800 rounded-xl hover:bg-slate-900 transition-colors">
                <div class="text-blue-400 text-3xl font-bold mb-2">-40%</div>
                <h5 class="text-white font-bold text-sm mb-1 uppercase tracking-tight">Merge Conflicts</h5>
                <p class="text-xs text-slate-500">Isolating long-running features in their own worktrees reduces accidental cross-branch pollution and stash collisions.</p>
            </div>
            <div class="p-6 bg-slate-900/50 border border-slate-800 rounded-xl hover:bg-slate-900 transition-colors">
                <div class="text-blue-400 text-3xl font-bold mb-2">Instant</div>
                <h5 class="text-white font-bold text-sm mb-1 uppercase tracking-tight">Context Switching</h5>
                <p class="text-xs text-slate-500">Eliminate the "Git checkout" lag. Switching between tasks is as fast as a <code class="text-blue-500">cd</code> command.</p>
            </div>
            <div class="p-6 bg-slate-900/50 border border-slate-800 rounded-xl hover:bg-slate-900 transition-colors">
                <div class="text-blue-400 text-3xl font-bold mb-2">+2x</div>
                <h5 class="text-white font-bold text-sm mb-1 uppercase tracking-tight">Review Efficiency</h5>
                <p class="text-xs text-slate-500">Review PRs in a dedicated 'review' worktree without disturbing your active development state or uncommitted work.</p>
            </div>
        </div>
    </div>

    <!-- 03. The Command Reference -->
    <div class="fade-in space-y-12">
        <div class="flex items-center gap-4">
            <span class="text-slate-400 font-bold text-2xl">03</span>
            <h2 class="text-3xl font-bold text-white tracking-wide">Command Reference</h2>
        </div>

        <div class="grid grid-cols-1 gap-6">
            <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-800 text-slate-300 tracking-widest uppercase text-xs">
                        <tr>
                            <th class="px-6 py-4">Action</th>
                            <th class="px-6 py-4">Command</th>
                            <th class="px-6 py-4">Description</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-800 text-slate-400 font-mono">
                        <tr>
                            <td class="px-6 py-4 text-white font-bold">Add</td>
                            <td class="px-6 py-4 text-blue-400">git worktree add &lt;path&gt; &lt;branch&gt;</td>
                            <td class="px-6 py-4">Creates a new worktree at the specified path.</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 text-white font-bold">List</td>
                            <td class="px-6 py-4 text-blue-400">git worktree list</td>
                            <td class="px-6 py-4">Shows all active worktrees and their branches.</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 text-white font-bold">Remove</td>
                            <td class="px-6 py-4 text-blue-400">git worktree remove &lt;path&gt;</td>
                            <td class="px-6 py-4">Safely detaches and deletes the worktree folder.</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 text-white font-bold">Move</td>
                            <td class="px-6 py-4 text-blue-400">git worktree move &lt;src&gt; &lt;dst&gt;</td>
                            <td class="px-6 py-4">Relocates a worktree to a new path.</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 text-white font-bold">Prune</td>
                            <td class="px-6 py-4 text-blue-400">git worktree prune</td>
                            <td class="px-6 py-4">Cleans up metadata for manually deleted worktrees.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 04. The Advantage Set -->
    <div class="fade-in space-y-12">
        <div class="flex items-center gap-4">
            <span class="text-blue-500 font-bold text-2xl">04</span>
            <h2 class="text-3xl font-bold text-white tracking-wide">Key Advantages</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="bg-slate-900 p-8 border border-slate-800 rounded-xl hover:border-blue-500 transition-colors">
                <div class="text-blue-500 font-bold text-xs tracking-widest uppercase mb-4">Performance</div>
                <h4 class="text-xl font-bold text-white mb-4">Zero-Latency Switching</h4>
                <p class="text-sm text-slate-400">Context switching is reduced to a `cd` command. No more waiting for Git to rewrite thousands of files or for your IDE to re-index the entire project.</p>
            </div>
            <div class="bg-slate-900 p-8 border border-slate-800 rounded-xl hover:border-blue-500 transition-colors">
                <div class="text-blue-500 font-bold text-xs tracking-widest uppercase mb-4">Isolation</div>
                <h4 class="text-xl font-bold text-white mb-4">Parallel Execution</h4>
                <p class="text-sm text-slate-400">Run long-running test suites or build processes on `main` in one terminal while simultaneously writing code on a feature branch in another.</p>
            </div>
            <div class="bg-slate-900 p-8 border border-slate-800 rounded-xl hover:border-blue-500 transition-colors">
                <div class="text-blue-500 font-bold text-xs tracking-widest uppercase mb-4">Architecture</div>
                <h4 class="text-xl font-bold text-white mb-4">Shared Object Store</h4>
                <p class="text-sm text-slate-400">All worktrees share the same `.bare` object database. You only download history once, and local commits in one worktree are immediately available in all others.</p>
            </div>
        </div>
    </div>

    <!-- 05. Implementation Protocol -->
    <div class="fade-in space-y-12">
        <div class="flex items-center gap-4">
            <span class="text-blue-500 font-bold text-2xl">05</span>
            <h2 class="text-3xl font-bold text-white tracking-wide">Implementation Steps</h2>
        </div>

        <div class="space-y-8">
            <div class="space-y-4">
                <h3 class="text-2xl font-bold text-white">Phase A: Initialization</h3>
                <p class="text-slate-400">Clone the repository as a bare instance into a hidden sub-directory. This ensures the root remains clean for your worktree folders.</p>
                <CodeBlock code={`mkdir my-project && cd my-project\ngit clone --bare git@github.com:user/repo.git .bare`} label="Shell" />
            </div>

            <div class="space-y-4">
                <h3 class="text-2xl font-bold text-white">Phase B: The Pointer</h3>
                <p class="text-slate-400">Establish the link between the root directory and the bare engine. This allows you to run Git commands from the root.</p>
                <CodeBlock code={`echo "gitdir: ./.bare" > .git`} label="Shell" />
            </div>

            <div class="space-y-4">
                <h3 class="text-2xl font-bold text-white">Phase C: Refspec Fix</h3>
                <p class="text-slate-400">Bare repos don't fetch remote branches by default for worktrees. This critical step ensures `git fetch` populates all branches.</p>
                <CodeBlock code={`git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"\ngit fetch origin`} label="Shell" />
            </div>
        </div>
    </div>

    <!-- 06. The Mindset Shift -->
    <div class="fade-in space-y-12">
        <div class="flex items-center gap-4">
            <span class="text-blue-500 font-bold text-2xl">06</span>
            <h2 class="text-3xl font-bold text-white tracking-wide">Workflow Patterns</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
            <div class="bg-slate-800 p-8 rounded-xl border border-slate-700">
                <h3 class="text-xl font-bold text-white mb-4">Feature-Based (Ephemeral)</h3>
                <p class="text-slate-400 text-sm leading-relaxed mb-6">Create a new folder for every task, then delete it when finished. Good for isolation, but requires constant environment setup.</p>
                <CodeBlock code={`git worktree add -b feat/auth ./auth\ncd ./auth && npm install`} label="Ephemeral Flow" />
            </div>
            <div class="bg-slate-800 p-8 rounded-xl border border-slate-700">
                <h3 class="text-xl font-bold text-white mb-4">Role-Based (Permanent)</h3>
                <p class="text-slate-400 text-sm leading-relaxed mb-6">Maintain permanent folders for specific roles (dev, hotfix, review). Use `git checkout` within them to swap branches instantly.</p>
                <CodeBlock code={`# In your permanent 'review' folder\ngit checkout feature-to-test\n# node_modules and cache stay intact`} label="Permanent Flow" />
            </div>
        </div>
    </div>

    <!-- 07. Standard Git Flow -->
    <div class="fade-in space-y-12">
        <div class="flex items-center gap-4">
            <span class="text-blue-500 font-bold text-2xl">07</span>
            <h2 class="text-3xl font-bold text-white tracking-wide">Standard Git Flow</h2>
        </div>

        <div class="space-y-6">
            <p class="text-slate-300">Working in a worktree is identical to a normal repo, with one major advantage: <strong>History is shared.</strong></p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="p-6 bg-slate-900 border border-slate-800 rounded-xl">
                    <h4 class="text-white font-bold mb-2">Committing</h4>
                    <p class="text-xs text-slate-500 mb-4">Commits are saved to the central `.bare` database immediately.</p>
                    <CodeBlock code="git add .\ngit commit -m 'feat: logic'" label="Git Commit" />
                </div>
                <div class="p-6 bg-slate-900 border border-slate-800 rounded-xl">
                    <h4 class="text-white font-bold mb-2">Syncing</h4>
                    <p class="text-xs text-slate-500 mb-4">Fetching in any worktree updates the `.bare` database for all of them.</p>
                    <CodeBlock code="git fetch origin\ngit pull origin main" label="Git Sync" />
                </div>
                <div class="p-6 bg-slate-900 border border-slate-800 rounded-xl">
                    <h4 class="text-white font-bold mb-2">Branching</h4>
                    <p class="text-xs text-slate-500 mb-4">Create branches in the hub, then spawn them as workspaces.</p>
                    <CodeBlock code="git branch feat-x\ngit worktree add ./feat-x feat-x" label="Git Branch" />
                </div>
            </div>
        </div>
    </div>

    <!-- 08. Advanced Maneuvers -->
    <div class="fade-in space-y-12">
        <div class="flex items-center gap-4">
            <span class="text-blue-500 font-bold text-2xl">08</span>
            <h2 class="text-3xl font-bold text-white tracking-wide">Advanced Techniques</h2>
        </div>

        <div class="bg-slate-800 p-10 rounded-xl border border-slate-700 space-y-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                <div class="space-y-4">
                    <h4 class="text-lg font-bold text-white uppercase">AI Agent Orchestration</h4>
                    <p class="text-slate-400 text-sm leading-relaxed">
                        Deploy AI agents into isolated worktrees to resolve tickets or run audits. This prevents the agent from overwriting your uncommitted work or polluting your primary dev environment.
                    </p>
                    <CodeBlock code={`git worktree add ../agent-task feature-42
# Launch agent in isolated path`} label="AI Deployment" />
                </div>
                <div class="space-y-4">
                    <h4 class="text-lg font-bold text-white uppercase">Detached HEAD Scratchpads</h4>
                    <p class="text-slate-400 text-sm leading-relaxed">
                        Need to check a file or run a quick experiment without creating a branch? Use a detached worktree.
                    </p>
                    <CodeBlock code={`git worktree add --detach ../scratch origin/main`} label="Scratch Disk" />
                </div>
            </div>
            
            <hr class="border-slate-800">

            <div class="space-y-6">
                <h4 class="text-lg font-bold text-white uppercase">CI/CD & Parallel Builds</h4>
                <p class="text-slate-400 text-sm leading-relaxed">
                    In high-performance CI pipelines, use worktrees to run multiple build flavors (e.g., dev vs prod) or test suites simultaneously against the same repository state. This eliminates redundant cloning time and optimizes disk space on the build agent.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-slate-950 border border-slate-800 rounded-lg">
                        <div class="text-blue-500 text-[0.6rem] font-bold mb-2 uppercase">Scenario: Matrix Testing</div>
                        <CodeBlock code={`# Run Node 18 and 20 tests in parallel\ngit worktree add ../test-18 branch-a\ngit worktree add ../test-20 branch-a --detach`} label="CI Matrix" />
                    </div>
                    <div class="p-4 bg-slate-950 border border-slate-800 rounded-lg">
                        <div class="text-blue-500 text-[0.6rem] font-bold mb-2 uppercase">Scenario: Deployment Prep</div>
                        <CodeBlock code={`# Build static assets while linting\ngit worktree add ../build main\ncd ../build && npm run build`} label="Parallel Build" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 09. Toolchain Integration -->
    <div class="fade-in space-y-12">
        <div class="flex items-center gap-4">
            <span class="text-slate-400 font-bold text-2xl">09</span>
            <h2 class="text-3xl font-bold text-white tracking-wide">Toolchain Integration</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="p-8 bg-slate-900 border border-slate-800 rounded-xl">
                <h4 class="text-blue-400 font-bold mb-4">Warp + Launch Configs</h4>
                <p class="text-xs text-slate-500 leading-relaxed mb-6">Combine worktrees with Warp's Launch Configurations to spark instant multi-pane work environments.</p>
                <CodeBlock code="wt open main" label="Warp" />
            </div>
            <div class="p-8 bg-slate-900 border border-slate-800 rounded-xl">
                <h4 class="text-blue-400 font-bold mb-4">fzf-worktree</h4>
                <p class="text-xs text-slate-500 leading-relaxed mb-6">Fuzzy search through your active worktrees and jump instantly to any branch folder.</p>
                <CodeBlock code="cd $(git worktree list | fzf | cut -d' ' -f1)" label="FZF" />
            </div>
            <div class="p-8 bg-slate-900 border border-slate-800 rounded-xl">
                <h4 class="text-blue-400 font-bold mb-4">Node.js / Bun</h4>
                <p class="text-xs text-slate-500 leading-relaxed mb-6">Use shared stores (pnpm/bun) to prevent `node_modules` explosion across worktrees.</p>
                <CodeBlock code="pnpm install --store-dir ~/.pnpm-store" label="PNPM" />
            </div>
        </div>
    </div>

    <!-- 10. Troubleshooting -->
    <div class="fade-in space-y-12">
        <div class="flex items-center gap-4">
            <span class="text-yellow-500 font-bold text-2xl">10</span>
            <h2 class="text-3xl font-bold text-white tracking-wide">Troubleshooting</h2>
        </div>

        <div class="space-y-6">
            <div class="border-l-2 border-yellow-500/30 pl-6 py-2">
                <h4 class="text-white font-bold mb-2">Error: Branch is already checked out</h4>
                <p class="text-slate-400 text-sm">Git prevents checking out the same branch in two worktrees. Use <code>git worktree add --detach</code> to view a branch that is already active elsewhere.</p>
            </div>
            <div class="border-l-2 border-yellow-500/30 pl-6 py-2">
                <h4 class="text-white font-bold mb-2">Issue: Remotes not showing up</h4>
                <p class="text-slate-400 text-sm">Ensure your Phase C (Refspec Fix) was executed correctly. Check <code>.bare/config</code> for the correct fetch refspec.</p>
            </div>
            <div class="border-l-2 border-yellow-500/30 pl-6 py-2">
                <h4 class="text-white font-bold mb-2">Cleanup: Removing Worktrees</h4>
                <p class="text-slate-400 text-sm">Don't just delete the folder. Use <code>git worktree remove &lt;path&gt;</code> to let the Bare Engine know the resource is released.</p>
            </div>
        </div>
    </div>
</section>
